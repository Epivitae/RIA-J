name: Sync to GitCode

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 第一步：把 GitHub 的代码拉取到 Action 运行环境
      - name: Checkout GitHub Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取完整历史，确保同步无误

      # 第二步：强制推送到 GitCode
      - name: Push to GitCode
        env:
          # --- 这里已修正 ---
          GITCODE_USER: "Epivitae"   # 你的 GitCode 用户名
          GITCODE_REPO: "RIA-J"      # 你的 GitCode 仓库名
          # -----------------
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
        run: |
          # 1. 构造带 Token 的远端地址 (格式：https://用户名:Token@gitcode.com/用户名/仓库名.git)
          # 注意：URL 中必须包含用户名和仓库名
          REMOTE_URL="https://${GITCODE_USER}:${GITCODE_TOKEN}@gitcode.com/${GITCODE_USER}/${GITCODE_REPO}.git"
          
          # 2. 安全地添加 GitCode 远端 (防止重复添加报错)
          git remote remove gitcode 2>/dev/null || true
          git remote add gitcode "$REMOTE_URL"
          
          # 3. 获取当前触发 Action 的分支名称 (使用 github.ref_name 更准确)
          CURRENT_BRANCH="${{ github.ref_name }}"
          
          echo "Target Branch: $CURRENT_BRANCH"
          echo "Pushing to GitCode Project: ${GITCODE_USER}/${GITCODE_REPO}..."
          
          # 4. 强制推送当前分支到 GitCode 对应分支
          git push gitcode HEAD:refs/heads/"$CURRENT_BRANCH" --force